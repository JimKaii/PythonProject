<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”å½±è¼•æ—…è¡Œå°åŠ©æ‰‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color:  #dfdddd;
            display: flex;
            gap: 20px;
            height: 100vh;
        }
        h1 {
            text-align: center;
            width: 100%;
        }
        h2 {
            text-align: center;
            width: 100%;
        }
        /* h3 {
            text-align: center;
            width: 100%;
        } */
        
        #map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #map {
            height: 90%;
            width: 100%;
            border-radius: 9px;
            background-color: #ccc;
        }
 
        #route-controls {
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 9px;
            background: rgba(148, 147, 147, 0.61);
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        #route-controls {
        text-align: center; /* æ‰€æœ‰å…§éƒ¨å…ƒç´ æ°´å¹³ç½®ä¸­ */
    }
    #route-controls label, #route-controls select, #route-controls button {
        display: block; /* æ¯å€‹å…ƒç´ ä½”ä¸€è¡Œ */
        margin: 10px auto; /* ä¸Šä¸‹é–“è·ä¸¦è‡ªå‹•å·¦å³ç½®ä¸­ */
    }
    #travelTime {
    font-size: 18px;
    color: #333;
    margin-top: 10px;
    text-align: center;
    font-weight: 600;  /* è¨­ç½®æ–‡å­—ç‚ºè¼ƒä¸­ç­‰ç²—ç´° */
}
        #info-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .info-box {
            background: rgba(148, 147, 147, 0.61);
            padding: 25px;
            border-radius: 50px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        select, input, button {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #dfdfdf;
            margin-bottom: 10px; 
        }
        button {
            background-color: #8b0aa58c;
            color: rgb(255, 255, 255);
            cursor: pointer;
        }
        ul {
    list-style-type: none;
}

@media (max-width: 768px) {
    body {
        flex-direction: column; /* è®“åœ°åœ–å’Œè³‡è¨Šå€å¡Šä¸Šä¸‹æ’åˆ— */
        height: auto; /* è®“å…§å®¹å¯æ»¾å‹• */
    }

    #map {
        height: 300px; /* æ‰‹æ©Ÿä¸Šç¸®å°åœ°åœ–é«˜åº¦ */
    }

    #route-controls {
        flex-direction: column; /* è®“é¸å–®æŒ‰éˆ•æ’åˆ—æˆç›´çš„ */
        align-items: center;
    }

    select, button {
        width: 90%; /* è®“æŒ‰éˆ•å’Œé¸å–®è®Šå¤§ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿé»æ“Š */
    }
}


       /* èŠå¤©æ¡†å®¹å™¨ */
     #chat-container {
    background-color: #f9f9f9;
    padding: 5px;
    border-radius: 20px;
    width: 250px;
    position: fixed;
    bottom: 270px;
    right: 20px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease-in-out;
}

.hidden {
    transform: translateX(100%);
}


/* è¨Šæ¯æ¡† - å•Ÿç”¨æ»¾å‹• */
#chat-box {
    flex-grow: 1;
    max-height: 300px;  /* å¢åŠ é«˜åº¦ */
    overflow-y: auto;   /* å•Ÿç”¨æ»¾å‹• */
    margin-bottom: 10px;
    padding-right: 10px;
    border: 1px solid #ddd;
    background-color: white;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
}
#chat-window {
    max-height: 250px;  /* è¨­å®šæœ€å¤§é«˜åº¦ï¼Œæ ¹æ“šéœ€æ±‚èª¿æ•´ */
    overflow-y: auto;   /* è¶…å‡ºç¯„åœæ™‚é¡¯ç¤ºæ»¾å‹•æ¢ */
    border: 1px solid #ddd; /* å¢åŠ é‚Šæ¡†ç¾è§€ */
    padding: 10px; 
    background: white;
}
/* è¨Šæ¯æ°£æ³¡ */
.message {
    margin: 5px;
    padding: 10px;
    border-radius: 8px;
    background-color: #f1f1f1;
    max-width: 80%;
    word-wrap: break-word;  /* ç¢ºä¿é•·æ–‡å­—ä¸æœƒæº¢å‡º */
}

/* ä½¿ç”¨è€…è¨Šæ¯ */
.user-message {
    text-align: right;
    background-color: #4CAF50;
    color: white;
    align-self: flex-end;
}

/* å°åŠ©æ‰‹è¨Šæ¯ */
.assistant-message {
    text-align: left;
    background-color: #2196F3;
    color: white;
    align-self: flex-start;
}

/* è¼¸å…¥æ¡† */
.input-area {
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
    padding-top: 5px;
}

input[type="text"] {
    flex-grow: 1;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ddd;
}

/* é€å‡ºæŒ‰éˆ• */
button {
    padding: 10px;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    border: none;
}
   
/* è®“è¼¸å…¥æ¡†å¯¬åº¦ 100% */
.input-area {
    width: 100%;
    display: flex;
    justify-content: center;
}

/* è®“æŒ‰éˆ•ç½®ä¸­ */
.button-area {
    text-align: center;  /* æ°´å¹³ç½®ä¸­ */
    margin-top: 5px;     /* è·é›¢è¼¸å…¥æ¡†ä¸€é»é–“è· */
}

/* è¨­å®šæŒ‰éˆ•æ¨£å¼ */
.button-area button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
    </style>
</head>
<body>
    
    <div id="map-container">
        <div id="route-controls">
            <label for="origin">å‡ºç™¼åœ°ï¼š</label>
            <select id="origin">
                <option value="current">ç›®å‰ä½ç½®</option>
                {% for location in locations %}
                    <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
            </select>
           
            <label for="destination">ç›®çš„åœ°ï¼š</label>
             
            <select id="destination">
                {% for location in locations %}
                    <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
            </select>
            
            <button id="routeButton">ç²å–è·¯ç·š</button>
        </div>
        <p id="travelTime" style="text-align: center; font-size: 20px; margin-top: 10px;"></p> <!-- é¡¯ç¤ºé è¨ˆè¡Œè»Šæ™‚é–“çš„ä½ç½® -->
        <div id="map"></div>
        
        
    </div>
    <div id="info-container">
        <div class="info-box">
            <h1>æ”å½±è¼•æ—…è¡Œå°åŠ©æ‰‹</h1>
        </div>
        <div class="info-box">
            <h2>å¤©æ°£è³‡è¨Š</h2>
            <div>
                <label for="weatherSelect">é¸æ“‡å€åŸŸï¼š</label>
                <select id="weatherSelect">
                    {% for location in locations %}
                        <option value="{{ location }}">{{ location }}</option>
                    {% endfor %}
                </select>
                <button id="confirmButton">ç¢ºèª</button>
            </div>
        
            <div id="weather-info-container">
                {% if weather_info %}
                    <ul>
                        {% for info in weather_info %}
                            <li>
                                <strong>â–ª å€åŸŸï¼š</strong>{{ info['district_name'] }} <br>
                                <strong>â–ª æº«åº¦ï¼š</strong>{{ info['temperature'] }}Â°C <br>
                                <strong>â–ª å¤©æ°£ç¾è±¡ï¼š</strong>{{ info['weather'] }} <br>
                                <strong>â–ª å¤©æ°£æè¿°ï¼š</strong>{{ info['weather_description'] }} <br>
                                <strong>â–ª é™é›¨æ™‚é–“ï¼š</strong>{{ info['startime'] }} <br>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>è«‹é¸æ“‡ä¸€å€‹å€åŸŸæŸ¥çœ‹å¤©æ°£è³‡è¨Šã€‚</p>
                {% endif %}
            </div>
        </div>
        
        
        <div class="info-box" id="shooting-advice-container">
            <h3>æ‹æ”å»ºè­°</h3>
            {{ shooting_advice | safe }}
        </div>
    </div>
    <div id="chat-container">
        <h2>èˆ‡æˆ‘å€‘çš„å°åŠ©æ‰‹èŠå¤©</h2>
        <!-- å°åŠ©æ‰‹å°è©±æ¡† -->
        <div id="chatbox">
            <div id="chat-window">
                <p><strong>å°åŠ©æ‰‹:</strong> ä½ å¥½ï¼éœ€è¦å»ºè­°å—ï¼Ÿ</p>
            </div>
            <!-- è¼¸å…¥å€åŸŸ -->
        <div class="input-area">
            <input id="user-input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." required>
        </div>

        <!-- ç½®ä¸­æŒ‰éˆ• -->
        <div class="button-area">
            <button onclick="sendMessage()">ç™¼é€</button>
        </div>
            <!-- <input id="user-input" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." required>
            <button onclick="sendMessage()"> ç™¼é€</button> -->
        </div>

            <!-- æŒ‰éˆ•ä¾†é¡¯ç¤º/éš±è—å°åŠ©æ‰‹ -->
            <button onclick="toggleChatbox()">é–‹å•Ÿ/é—œé–‰ å°åŠ©æ‰‹</button>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script>

window.onload = function () {
    const savedLocation = localStorage.getItem("selectedWeatherLocation");
    if (savedLocation) {
        document.getElementById("weatherSelect").value = savedLocation;
    }
};

document.getElementById("confirmButton").onclick = function () {
    const selectedLocation = document.getElementById("weatherSelect").value;
    // å„²å­˜åˆ° localStorage
    localStorage.setItem("selectedWeatherLocation", selectedLocation);
    
    // å‘å¾Œç«¯è«‹æ±‚è©²å€åŸŸçš„å¤©æ°£è³‡è¨Š
    fetch(`/get_coordinates?city_name=${selectedLocation}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('selectedValue').textContent = data.error;
                    } else {
                        // å–å¾—ç¶“ç·¯åº¦å¾Œï¼Œå°‡ä½¿ç”¨è€…é‡å®šå‘åˆ° weather.htmlï¼Œä¸¦å‚³éåƒæ•¸
                        const { latitude, longitude, city } = data;
    
                        const queryString = new URLSearchParams({
                            city: city,
                            lat: latitude,
                            lng: longitude
                        }).toString();
    
                        // é€²è¡Œè·³è½‰
                        window.location.href = `/weather?${queryString}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        let map, marker, directionsService, directionsRenderer, userLocation;
        const locationCoordinates= {
            'ä¸­å€': { lat: 24.1457, lng: 120.6835 },
    'æ±å€': { lat: 24.1479, lng: 120.7370 },
    'å—å€': { lat: 24.1420, lng: 120.6610 },
    'è¥¿å€': { lat: 24.1460, lng: 120.6450 },
    'åŒ—å€': { lat: 24.1712, lng: 120.6802 },
    'è¥¿å±¯å€': { lat: 24.1681, lng: 120.6419 },
    'å—å±¯å€': { lat: 24.1433, lng: 120.6533 },
    'åŒ—å±¯å€': { lat: 24.1798, lng: 120.6879 },
    'å¤ªå¹³å€': { lat: 24.1410, lng: 120.7212 },
    'å¤§é‡Œå€': { lat: 24.2195, lng: 120.6821 },
    'éœ§å³°å€': { lat: 24.1857, lng: 120.7375 },
    'çƒæ—¥å€': { lat: 24.1461, lng: 120.5843 },
    'è±åŸå€': { lat: 24.2620, lng: 120.7328 },
    'åé‡Œå€': { lat: 24.3078, lng: 120.7103 },
    'çŸ³å²¡å€': { lat: 24.2556, lng: 120.7481 },
    'æ±å‹¢å€': { lat: 24.2965, lng: 120.8594 },
    'å¤§ç”²å€': { lat: 24.3147, lng: 120.6185 },
    'æ¸…æ°´å€': { lat: 24.3179, lng: 120.4532 },
    'æ²™é¹¿å€': { lat: 24.2359, lng: 120.5958 },
    'æ¢§æ£²å€': { lat: 24.2349, lng: 120.5033 },
    'é¾äº•å€': { lat: 24.2066, lng: 120.5374 },
    'å¤§è‚šå€': { lat: 24.2112, lng: 120.5530 },
    'å¤§å®‰å€': { lat: 24.4244, lng: 120.4909 },
    'å¥è¡Œå€': { lat: 24.1820, lng: 120.7615 },
    'å¤§é›…å€': { lat: 24.2556, lng: 120.6154 },
    'ç¥å²¡å€': { lat: 24.2977, lng: 120.6845 },
    'æ–°ç¤¾å€': { lat: 24.2689, lng: 120.8945 }
};
        

        let placeMarkers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), { 
                zoom: 14 ,
                mapId: "74e5bfb0d7e26962"
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "æ‚¨çš„ä½ç½®"
                    });
                });
            } else {
                alert("ç„¡æ³•ç²å–ç•¶å‰ä½ç½®");
            }
        }
        document.getElementById("routeButton").onclick = function () {
    const origin = document.getElementById("origin").value;
    const destination = document.getElementById("destination").value;

    let originCoordinates = origin === "current" && userLocation ? userLocation : locationCoordinates[origin];
    let destinationCoordinates = locationCoordinates[destination];

    if (originCoordinates && destinationCoordinates) {
        calculateRoute(originCoordinates, destinationCoordinates);
        searchNearby(originCoordinates); // ğŸ” æœå°‹å‡ºç™¼åœ°é™„è¿‘æ™¯é»
        searchNearby(destinationCoordinates); // ğŸ” æœå°‹ç›®çš„åœ°é™„è¿‘æ™¯é»
    }
};

        function calculateRoute(origin, destination) {
            let request = {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function (response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                    let route = response.routes[0].legs[0];
                    document.getElementById("travelTime").innerText = "é è¨ˆè¡Œè»Šæ™‚é–“ï¼š" + route.duration.text;

                    // æœå°‹å‡ºç™¼åœ°å’Œç›®çš„åœ°é™„è¿‘çš„æ™¯é»
                    searchNearby(origin);
                    searchNearby(destination);
                } else {
                    alert("è·¯ç·šè¨ˆç®—å¤±æ•—ï¼š" + status);
                }
            });
        }

        async function searchNearby(location) {
    if (!location) {
        alert("ç„¡æ³•ç²å–ä½ç½®è³‡è¨Š");
        return;
    }

    // æ¸…é™¤èˆŠæ¨™è¨˜
    placeMarkers.forEach(marker => marker.setMap(null));
    placeMarkers = [];

    const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");

    let center = new google.maps.LatLng(location.lat, location.lng);
    const request = {
        fields: ["displayName", "location", "formattedAddress", "businessStatus"],
        locationRestriction: {
            center: center,
            radius: 2000, // æœå°‹åŠå¾‘ï¼ˆå…¬å°ºï¼‰
        },
        includedPrimaryTypes: [
                        "tourist_attraction",   // æ™¯é»                        
                        "park",                 // å…¬åœ’                        
                    ], // é™å®šæ™¯é»é¡å‹
        maxResultCount: 10,
        rankPreference: SearchNearbyRankPreference.POPULARITY,
        language: "zh-TW",
    };

    try {
        //@ts-ignore
        const { places } = await Place.searchNearby(request);

        if (places.length) {
            places.forEach((place) => {
                let marker = new google.maps.Marker({
                    map: map,
                    position: place.location,
                    title: place.displayName
                });

                // å„²å­˜é¡å¤–è³‡æ–™åˆ° marker
                marker.placeInfo = {
                    name: place.displayName,
                    address: place.formattedAddress || "åœ°å€ä¸è©³",
                    status: place.businessStatus || "æœªçŸ¥",
                    location: place.location // âœ¨ å„²å­˜åº§æ¨™
                };

                placeMarkers.push(marker);

                // ç›£è½æ¨™è¨˜é»æ“Šäº‹ä»¶ï¼Œé¡¯ç¤ºè³‡è¨Šä¸¦è¦åŠƒè·¯ç·š
                google.maps.event.addListener(marker, "click", function() {
                    const infoWindowContent = `
                        <h3>${marker.placeInfo.name}</h3>
                        <p>ğŸ“ åœ°å€: ${marker.placeInfo.address}</p>
                        <p>ğŸŸ¢ ç‡Ÿæ¥­ç‹€æ…‹: ${marker.placeInfo.status}</p>
                        <button id="routeToHere" style="margin-top:10px;">ğŸš— è¦åŠƒè·¯ç·š</button>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoWindowContent
                    });

                    infoWindow.open(map, marker); // é¡¯ç¤ºè³‡è¨Šè¦–çª—

                    // ç›£è½æŒ‰éˆ•é»æ“Šäº‹ä»¶
                    setTimeout(() => {
                        document.getElementById("routeToHere").onclick = function () {
                            if (userLocation) {
                                calculateRoute(userLocation, marker.placeInfo.location);
                            } else {
                                alert("ç„¡æ³•ç²å–æ‚¨çš„ç•¶å‰ä½ç½®");
                            }
                        };
                    }, 100); // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æŒ‰éˆ•å·²ç¶“æ¸²æŸ“
                });
            });
        } else {
            console.log("é™„è¿‘æ²’æœ‰æ‰¾åˆ°æ™¯é»");
        }
    } catch (error) {
        console.error("æœå°‹é™„è¿‘æ™¯é»å¤±æ•—:", error);
    }
}
        

function toggleChatbox() {
        var chatbox = document.getElementById('chatbox');
        chatbox.style.display = chatbox.style.display === 'none' ? 'block' : 'none';
    }

// ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œåˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œå›åˆ°é ‚éƒ¨ã€æŒ‰éˆ•
document.getElementById('chat-window').addEventListener('scroll', checkScrollButton);

    function sendMessage() {
        var userInput = document.getElementById('user-input').value;
        if (!userInput) return;

        var chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML += `<p><strong>ä½ :</strong> ${userInput}</p>`;

        // ç™¼é€è¨Šæ¯åˆ° Flask ä¼ºæœå™¨
        fetch('/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userInput })
        })
        .then(response => response.json())
        .then(data => {
            chatWindow.innerHTML += `<p><strong>å°åŠ©æ‰‹:</strong> ${data.response}</p>`;
            document.getElementById('user-input').value = '';  // æ¸…ç©ºè¼¸å…¥æ¡†
        })
        .catch(error => {
            console.error('éŒ¯èª¤:', error);
            chatWindow.innerHTML += `<p><strong>å°åŠ©æ‰‹:</strong> æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ã€‚</p>`;
        });
    }


    function scrollToBottom() {
    var chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
}


function toggleChatbox() {
    var chatbox = document.getElementById("chat-container");
    chatbox.classList.toggle("hidden");
}
</script>

</script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key={api}&callback=initMap&language=zh-TW"></script>
</body>
</html>